{{>header}}

<body style="background-color: #f8f9fa;">
  <div class="container py-5">

    <h1 class="mb-4 text-center fw-semibold">Editar juego: {{game.name}}</h1>
    <a href="/" class="btn btn-outline-secondary mb-4">â¬… Volver</a>

    {{#successMessage}}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      {{successMessage}}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {{/successMessage}}

    <form id="editGameForm" action="/edit/game/{{game.id}}" method="post">

      <!-- DATOS DEL JUEGO -->
      <div class="p-4 rounded-4 mb-5 shadow-sm border border-primary-subtle" style="background-color:#e9f2ff;">
        <h3 class="mb-4 text-primary fw-semibold">ðŸŽ® Datos del juego</h3>

        <div class="mb-3">
          <label class="form-label text-primary">Nombre</label>
          <input type="text" name="name" class="form-control" value="{{game.name}}" required>
        </div>

        <div class="mb-3">
          <label class="form-label text-primary">DescripciÃ³n</label>
          <textarea name="description" class="form-control" rows="3">{{game.description}}</textarea>
        </div>

        <div class="row">
          <div class="col-md-6 mb-2">
            <div class="form-check">
              <input type="checkbox" name="hasLeaderboard" class="form-check-input" {{#game.hasLeaderboard}}checked{{/game.hasLeaderboard}}>
              <label class="form-check-label text-primary">Tiene leaderboard</label>
            </div>
          </div>
          <div class="col-md-6 mb-2">
            <div class="form-check">
              <input type="checkbox" name="manual" class="form-check-input" {{#game.manual}}checked{{/game.manual}}>
              <label class="form-check-label text-primary">Manual</label>
            </div>
          </div>
        </div>
      </div>

      <!-- FASES -->
      <div class="p-4 rounded-4 mb-4 shadow-sm border border-success-subtle" style="background-color:#e9fcef;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="text-success fw-semibold mb-0">âœ… Fases del juego</h3>

          <!-- BotÃ³n que despliega el bloque con slots de nuevas fases -->
          <button class="btn btn-success btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#addPhasesBlock" aria-expanded="false" aria-controls="addPhasesBlock">
            âž• AÃ±adir fase
          </button>
        </div>

        <div class="accordion" id="phasesAccordion">
          <!-- Fases existentes -->
          {{#phases}}
          <div class="accordion-item">
            <h2 class="accordion-header" id="phase-{{id}}">
              <button class="accordion-button collapsed fw-semibold text-success" type="button"
                data-bs-toggle="collapse" data-bs-target="#collapse-{{id}}" aria-expanded="false" aria-controls="collapse-{{id}}">
                {{phaseName}}
              </button>
            </h2>

            <div id="collapse-{{id}}" class="accordion-collapse collapse" data-bs-parent="#phasesAccordion">
              <div class="accordion-body">
                <input type="hidden" name="phases[{{idFalse}}].id" value="{{id}}">

                <div class="mb-3">
                  <label class="form-label">Nombre de fase</label>
                  <input type="text" name="phases[{{idFalse}}].phaseName" class="form-control" value="{{phaseName}}">
                </div>

                <div class="mb-3">
                  <label class="form-label">DescripciÃ³n</label>
                  <input type="text" name="phases[{{idFalse}}].description" class="form-control" value="{{description}}">
                </div>

                <!-- BotÃ³n AÃ±adir enigma (desplegable solo con descripciÃ³n del enigma nuevo) -->
                <button class="btn btn-warning btn-sm mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#addEnigmas-{{idFalse}}" aria-expanded="false">
                  âž• AÃ±adir enigma
                </button>

                <!-- Enigmas existentes -->
                {{#enigmas}}
                <div class="card mb-3 border-light shadow-sm">
                  <div class="card-body">
                    <input type="hidden" name="phases[{{idFalse}}].enigmas[{{idTreak}}].id" value="{{id}}">

                    <div class="mb-2">
                      <label class="form-label">Pregunta</label>
                      <textarea name="phases[{{idFalse}}].enigmas[{{idTreak}}].enigma" class="form-control">{{enigma}}</textarea>
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Respuesta</label>
                      <input type="text" name="phases[{{idFalse}}].enigmas[{{idTreak}}].answer" class="form-control" value="{{answer}}">
                    </div>
                  </div>
                </div>
                {{/enigmas}}

                <!-- Desplegable con SLOTS de nuevos enigmas (solo descripciÃ³n) -->
                <div id="addEnigmas-{{idFalse}}" class="collapse">
                  {{#extraEnigmas}}
                  <div class="card mb-3 border-warning-subtle">
                    <div class="card-body bg-light">
                      <h6 class="fw-semibold mb-2">âž• Nuevo enigma</h6>
                      <!-- descripciÃ³n del nuevo enigma; el backend decidirÃ¡ cÃ³mo mapearla (ej. a 'enigma' o un campo 'description' si existe) -->
                      <div class="mb-2">
                        <label class="form-label">DescripciÃ³n del enigma</label>
                        <textarea name="phases[{{idFalse}}].enigmas[{{.}}].enigma" class="form-control" placeholder="Escribe la descripciÃ³n / enunciado"></textarea>
                      </div>
                    </div>
                  </div>
                  {{/extraEnigmas}}
                </div>

              </div>
            </div>
          </div>
          {{/phases}}

          <!-- Bloque desplegable: aÃ±adir NUEVAS FASES (solo descripciÃ³n) -->
          <div id="addPhasesBlock" class="collapse mt-3">
            {{#extraPhases}}
            <div class="accordion-item">
              <h2 class="accordion-header" id="new-phase-{{index}}">
                <button class="accordion-button collapsed fw-semibold text-success" type="button"
                  data-bs-toggle="collapse" data-bs-target="#collapse-new-{{index}}" aria-expanded="false"
                  aria-controls="collapse-new-{{index}}">
                  (Nueva fase {{index}})
                </button>
              </h2>

              <div id="collapse-new-{{index}}" class="accordion-collapse collapse" data-bs-parent="#phasesAccordion">
                <div class="accordion-body">
                  <!-- Solo descripciÃ³n de la fase nueva -->
                  <div class="mb-3">
                    <label class="form-label">Nombre de fase</label>
                    <input type="text" name="phases[{{index}}].phaseName" class="form-control" placeholder="Ej. Fase X">
                  </div>

                  <div class="mb-3">
                    <label class="form-label">DescripciÃ³n de la fase</label>
                    <textarea name="phases[{{index}}].description" class="form-control" rows="2" placeholder="Describe brevemente la fase"></textarea>
                  </div>

                  <!-- BotÃ³n para desplegar 'aÃ±adir enigma' dentro de la nueva fase -->
                  <button class="btn btn-warning btn-sm mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#addEnigmasNew-{{index}}" aria-expanded="false">
                    âž• AÃ±adir enigma
                  </button>

                  <div id="addEnigmasNew-{{index}}" class="collapse">
                    <!-- Uno o mÃ¡s slots de enigma nuevo (solo descripciÃ³n) -->
                    <div class="card mb-3 border-warning-subtle">
                      <div class="card-body bg-light">
                        <h6 class="fw-semibold mb-2">âž• Nuevo enigma</h6>
                        <div class="mb-2">
                          <label class="form-label">DescripciÃ³n del enigma</label>
                          <textarea name="phases[{{index}}].enigmas[0].enigma" class="form-control" placeholder="Escribe la descripciÃ³n / enunciado"></textarea>
                        </div>
                      </div>
                    </div>

                    <div class="card mb-3 border-warning-subtle">
                      <div class="card-body bg-light">
                        <h6 class="fw-semibold mb-2">âž• Nuevo enigma</h6>
                        <div class="mb-2">
                          <label class="form-label">DescripciÃ³n del enigma</label>
                          <textarea name="phases[{{index}}].enigmas[1].enigma" class="form-control" placeholder="(opcional) Otro enigma"></textarea>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
            {{/extraPhases}}
          </div>
        </div>
      </div>

      <!-- GUARDAR -->
      <div class="mt-4">
        <button type="submit" class="btn btn-primary w-100 py-2">ðŸ’¾ Guardar todo</button>
      </div>
    </form>
  </div>

  {{>footer}}
</body>
